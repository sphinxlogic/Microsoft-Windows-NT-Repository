	.TITLE	TST_GIGAPORT
	.IDENT	/V1-001/
; Test routine to get port map from gigaswitch 
; Modifications:
;

;
	.LIBRARY	"SYS$LIBRARY:LIB.MLB"
        .LIBRARY        "EMU5_LIB:EMU5.MLB"
        $IODEF                          ;Define I/O functions and modifiers
        $NMADEF                         ;Define Network Management parameters
	$SECDEF				; Global Section 
	$SSDEF
	EMUSNMPDEF
	EMUSYSDEF

	.PSECT	TST_GIGAPORT_D,WRT,NOEXE,PIC,SHR,QUAD

ADDRTBL:	
	.BYTE	165,47,4,119
	.BYTE	165,47,4,120
	.BYTE	165,47,4,121
	.BYTE	165,47,4,122
	.LONG	0
retlen:	.long	0
COMMSTRING:	.BLKB	32
RETBUF:		.BLKB	4096
RETBUF_DESC:	.LONG	.-RETBUF
		.ADDRESS  RETBUF
CUROBJ:		.LONG	0
; FAO
NAMBUF:		.BLKB	80
NAMDESC:        .LONG	.-NAMBUF
		.ADDRESS  NAMBUF

FAOBUF:		.BLKB	80
FAODESC:        .LONG	.-FAOBUF
		.ADDRESS  FAOBUF
ENTRYMSG:	.ASCID	/!UB.!UB.!UB.!UB> !UL !AS/
EMU2ASNTBL:
	.BYTE   11                      ; FDDIMAC TABLE
STDOBJ:
	.BYTE   43,6,1,2,1,10,15,2,2,1,0 
; To process the entire table continue GETNEXT until offset TBLID in returned
; obj .ne. last
; Param number is at offset INDEX
INDEX =	10
TBLID = 8
PARAMS:	.QUAD	129		; Params 
       .PSECT TST_GIGAPORT_C,EXE,NOWRT,LONG
	.ENTRY	TST_GIGAPORT,^M<R2,R3,R4,R5,R6,R7,R8,R9,R10,R11>
	MOVAL	ADDRTBL,R6
10$:
	TSTL	(R6)
	BNEQ	20$
	RET
20$:
	PUSHAL	COMMSTRING
	PUSHAL	RETLEN
	PUSHAL	EMU2ASNTBL
	PUSHAL	PARAMS
	PUSHAL	CUROBJ
	PUSHAL	EMU2ASNTBL
	PUSHAL	RETBUF_DESC
	PUSHL	R6
	CALLS	#8,G^GETSNMPROW
	BLBS	R0,30$
	brb	35$
30$:
	BSBW	PRINT
	PUSHAL	COMMSTRING
	PUSHAL	RETLEN
	PUSHAL	EMU2ASNTBL
	PUSHAL	PARAMS
	PUSHAL	CUROBJ
	PUSHL	CUROBJ
	PUSHAL	RETBUF_DESC
	PUSHL	R6
	CALLS	#8,G^GETSNMPROW
	BLBS	R0,40$
35$:
	ADDL	#4,R6
	BRW	10$
40$:
	CMPL	#SS$_NOMOREITEMS,R0
	BNEQU	30$
	ADDL	#4,R6
	BRW	10$
50$:
	BSBW	PRINT
	BRB	30$
; ID
print:
; Translate addr
	MOVAL	RETBUF,R8
	MOVL	#80,NAMDESC
	PUSHAL	NAMDESC
	ADDL3   #5,R8,-(SP)
	pushl	#6
	PUSHL	#SYS_PID_C_PSRETH
	CALLS	#4,G^ADDR2NAME
	
	


100$:
	MOVL	#80,FAODESC
	PUSHAL	NAMDESC
	MOVZBL	2(R8),-(SP)          ; PORT
	MOVZBL	3(R6),-(SP)          ; IP
	MOVZBL	2(R6),-(SP)
	MOVZBL	1(R6),-(SP)
	MOVZBL	(R6),-(SP)
	PUSHAL	FAODESC
	PUSHAL	FAODESC
	PUSHAL	ENTRYMSG
	CALLS	#9,G^SYS$FAO
	BSBW	ERROR_CHK
	PUSHAL	FAODESC
	CALLS	#1,G^LIB$PUT_OUTPUT
	BSBW	ERROR_CHK
	rsb
ERROR_CHK:
	BLBC	R0,10$
	RSB
10$:
	RET

	.END	TST_GIGAPORT
