From: Peter Jannesen <peter@ncs.nl>
Subject: v02i027: ncompress - (Ver. 4.2.3) an improved file compressor, Patch01
Newsgroups: comp.sources.reviewed
Approved: csr@calvin.dgbt.doc.ca

Submitted-by: Peter Jannesen <peter@ncs.nl>
Posting-number: Volume 2, Issue 27
Archive-name: ncompress/patch01
Patch-To: ncompress: Volume 2, Issue 24-26

This patch brings (N)compress to version 4.2.4.  It fixes various
problems reported to the author after the initial posting to CSR.

This is a standard patch.  To apply, just direct this file to the
"patch" program (e.g., "patch <patch1").



Index: Changes
1c1,10
< (N)compress cersion 4.2.2
---
> (N)compress version 4.2.4
> 	o Fix '-c' flag.
> 	o Fix utime error.
> 	o Added AMIGA support (Sascha Wildner).
> 	o Div. remarks added.
> 
> (N)compress version 4.2.3
> 	o Comp.source.reveiwed release.
> 
> (N)compress version 4.2.2
Index: Makefile.def
1c1
< # Makefile
---
> # Makefile generated by build.
14a15,17
> #	-DAMIGA=1					Amiga support.
> #	-DNOFUNCDEF=1				Disable libary function definitions in
> #								compress42.c
28c31
< options= -DIRENT=1 -DUSERMEM=800000 -DREGISTERS=3  
---
> options= -DDIRENT=1 -DUSERMEM=800000 -DREGISTERS=3
32a36
> 
37,48c41,54
< 		[ -f /usr/local/bin/compress ] && 			{ rm -f /usr/local/bin/compress.old ; 	  		mv /usr/local/bin/compress /usr/local/bin/compress.old ; }
< 		rm -f /usr/local/bin/uncompress /usr/local/bin/zcat
< 		cp compress /usr/local/bin/compress
< 		strip /usr/local/bin/compress
< 		rm -f /usr/local/bin/uncompress
< 		ln /usr/local/bin/compress /usr/local/bin/uncompress
< 		rm -f  /usr/local/bin/zcat
< 		ln -f /usr/local/bin/compress /usr/local/bin/zcat
< 		cp zcmp zdiff zmore /usr/local/bin/.
< 		chmod 0755 /usr/local/bin/compress /usr/local/bin/zcmp /usr/local/bin/zdiff                    /usr/local/bin/zmore
< 		cp compress.1 zcmp.1 zmore.1 /usr/local/man/man1/.
< 		chmod 0644 /usr/local/man/man1/compress.1 /usr/local/man/man1/zcmp.1 				   /usr/local/man/man1/zmore.1
---
> 		[ -f $(BINDIR)/compress ] && \
> 			{ rm -f $(BINDIR)/compress.old ; \
> 	  		mv $(BINDIR)/compress $(BINDIR)/compress.old ; }
> 		rm -f $(BINDIR)/uncompress $(BINDIR)/zcat
> 		cp compress $(BINDIR)/compress
> 		strip $(BINDIR)/compress
> 		rm -f $(BINDIR)/uncompress
> 		ln $(BINDIR)/compress $(BINDIR)/uncompress
> 		rm -f $(BINDIR)/zcat
> 		ln -f $(BINDIR)/compress $(BINDIR)/zcat
> 		cp zcmp zdiff zmore $(BINDIR)/.
> 		chmod 0755 $(BINDIR)/compress $(BINDIR)/zcmp $(BINDIR)/zdiff $(BINDIR)/zmore
> 		cp compress.1 zcmp.1 zmore.1 $(MANDIR)/.
> 		chmod 0644 $(MANDIR)/compress.1 $(MANDIR)/zcmp.1 $(MANDIR)/zmore.1
Index: README
81a82,85
> - There has been 1 problem report in relation to GCC 2.0 on a sparc
>   workstation. GCC 2.0 seems to generate a bad compress. Use the
>   standard c compiler 'cc'.
> 
Index: build
4c4
< version="4.2.3"
---
> version="4.2.4"
53c53
< 		echo "12.  Word must start at even addres: ${NOALLIGN}, Bytorder on your system: ${BYTEORDER}"
---
> 		echo "12.  Word must start at even addres: ${NOALLIGN}, Bytorder on your system: ${BYTEORDER} (1=msb)"
769a770,772
> #	-DAMIGA=1					Amiga support.
> #	-DNOFUNCDEF=1				Disable libary function definitions in
> #								compress42.c
793,808c796,809
< 		[ -f ${BINDIR}/compress ] && \
< 			{ rm -f ${BINDIR}/compress.old ; \
< 	  		mv ${BINDIR}/compress ${BINDIR}/compress.old ; }
< 		rm -f ${BINDIR}/uncompress ${BINDIR}/zcat
< 		cp compress ${BINDIR}/compress
< 		strip ${BINDIR}/compress
< 		rm -f ${BINDIR}/uncompress
< 		ln ${BINDIR}/compress ${BINDIR}/uncompress
< 		rm -f  ${BINDIR}/zcat
< 		ln -f ${BINDIR}/compress ${BINDIR}/zcat
< 		cp zcmp zdiff zmore ${BINDIR}/.
< 		chmod 0755 ${BINDIR}/compress ${BINDIR}/zcmp ${BINDIR}/zdiff \
<                    ${BINDIR}/zmore
< 		cp compress.1 zcmp.1 zmore.1 ${MANDIR}/.
< 		chmod 0644 ${MANDIR}/compress.1 ${MANDIR}/zcmp.1 \
< 				   ${MANDIR}/zmore.1
---
> 		[ -f \$(BINDIR)/compress ] && \\
> 			{ rm -f \$(BINDIR)/compress.old ; \\
> 	  		mv \$(BINDIR)/compress \$(BINDIR)/compress.old ; }
> 		rm -f \$(BINDIR)/uncompress \$(BINDIR)/zcat
> 		cp compress \$(BINDIR)/compress
> 		strip \$(BINDIR)/compress
> 		rm -f \$(BINDIR)/uncompress
> 		ln \$(BINDIR)/compress \$(BINDIR)/uncompress
> 		rm -f \$(BINDIR)/zcat
> 		ln -f \$(BINDIR)/compress \$(BINDIR)/zcat
> 		cp zcmp zdiff zmore \$(BINDIR)/.
> 		chmod 0755 \$(BINDIR)/compress \$(BINDIR)/zcmp \$(BINDIR)/zdiff \$(BINDIR)/zmore
> 		cp compress.1 zcmp.1 zmore.1 \$(MANDIR)/.
> 		chmod 0644 \$(MANDIR)/compress.1 \$(MANDIR)/zcmp.1 \$(MANDIR)/zmore.1
Index: compress42.c
792c792
< 						do_decomp = zcat_flg = 1;
---
> 						zcat_flg = 1;
803c803
< 						fprintf(stderr, "%s -r not availble (du to missing directory functions)\n", **argv);
---
> 						fprintf(stderr, "%s -r not availble (du to missing directory functions)\n", *argv);
985c985
< 				if (strcmp(tempname + strlen(tempname) - 2, ".Z") == 0)
---
> 		    	if (!zcat_flg)
987,989c987,991
< 		 	 		fprintf(stderr, "%s: already has .Z suffix -- no change\n", tempname);
< 			  		return;
< 				}
---
> 					if (strcmp(tempname + strlen(tempname) - 2, ".Z") == 0)
> 					{
> 		 	 			fprintf(stderr, "%s: already has .Z suffix -- no change\n", tempname);
> 			  			return;
> 					}
991,996c993,999
< 				if (infstat.st_nlink > 1 && (!force))
< 				{
< 			  		fprintf(stderr, "%s has %d other links: unchanged\n",
< 									tempname, infstat.st_nlink - 1);
< 					exit_code = 1;
< 			  		return;
---
> 					if (infstat.st_nlink > 1 && (!force))
> 					{
> 			  			fprintf(stderr, "%s has %d other links: unchanged\n",
> 										tempname, infstat.st_nlink - 1);
> 						exit_code = 1;
> 			  			return;
> 					}
1207,1216d1209
< 					if (chmod(ofname, infstat.st_mode & 07777))		/* Copy modes */
< 					{
< 						fprintf(stderr, "\nchmod error (ignored) ");
< 				    	perror(ofname);
< 						exit_code = 1;
< 					}
< #ifndef	DOS
< 					chown(ofname, infstat.st_uid, infstat.st_gid);	/* Copy ownership */
< #endif
< 
1226a1220,1230
> #ifndef	AMIGA
> 					if (chmod(ofname, infstat.st_mode & 07777))		/* Copy modes */
> 					{
> 						fprintf(stderr, "\nchmod error (ignored) ");
> 				    	perror(ofname);
> 						exit_code = 1;
> 					}
> #ifndef	DOS
> 					chown(ofname, infstat.st_uid, infstat.st_gid);	/* Copy ownership */
> #endif
> #endif
Index: patchlevel.h
1c1
< static char	ident[] = "@(#)(N)compress 4.2.3";
---
> static char	ident[] = "@(#)(N)compress 4.2.4";



exit 0 # Just in case...
